<!doctype html>
<html data-n-head-ssr lang="zh-CN" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22zh-CN%22%7D%7D">
<head>
  <title>uni-app对微信小程序云函数的适配</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta data-n-head="ssr" data-hid="description" name="description" content="指尖魔法屋"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="/highlight/atom-one-dark.min.css"><link data-n-head="ssr" rel="stylesheet" href="/style.css"><script data-n-head="ssr" src="/highlight/highlight.min.js"></script><link rel="preload" href="/_nuxt/b0f8911.js" as="script"><link rel="preload" href="/_nuxt/fc6b942.js" as="script"><link rel="preload" href="/_nuxt/css/a5b6cb0.css" as="style"><link rel="preload" href="/_nuxt/a1b9b3d.js" as="script"><link rel="preload" href="/_nuxt/02b3e78.js" as="script"><link rel="stylesheet" href="/_nuxt/css/a5b6cb0.css"><link rel="preload" href="/_nuxt/static/1619942794/post/466/state.js" as="script"><link rel="preload" href="/_nuxt/static/1619942794/post/466/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1619942794/manifest.js" as="script">
</head>
<body>
<div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div class="container"><div class="article-content"><h1 class="article-title">uni-app对微信小程序云函数的适配</h1> <div><h2 id="引言">引言</h2>
<p>熟悉uni-app的人应该都知道，uni-app并未对微信小程序云函数（本文统称云函数）进行相应的适配。但是，如果我们在某些业务场景的下需要使用云函数呢？我们知道，云函数可以复制到微信开发者工具，这样的话我们不得不每次编译一次就手动复制一次，不得不说麻烦至极。本文就问题做出以下解决方案。</p>
<h3 id="本文环境">本文环境</h3>
<ol>
<li>Hbuilder X</li>
</ol>
<p><img src="https://blog.cdn.thinkmoon.cn/blog/typecho/2019-10-22T01:28:39.png" alt="Hbuilder X版本"></p>
<ol start="2">
<li>微信开发者工具</li>
</ol>
<p><img src="https://blog.cdn.thinkmoon.cn/blog/typecho/2019-10-22T01:32:01.png" alt="微信开发者工具版本"></p>
<h2 id="创建云函数目录">创建云函数目录</h2>
<p>首先，我们需要在uni-app项目文件夹下，创建一个云函数目录，路径随意，我这里是<code>functions</code>。然后先随便在里面放一些文件，这里以<code>new_file.css</code>为例。</p>
<h2 id="修改manifestjson">修改<code>manifest.json</code></h2>
<p>在uni-app根目录下，修改<code>manifest.json</code>中的微信小程序项，结构如下</p>
<pre><code class="language-json">"mp-weixin" : {
        /* 小程序特有相关 */
        "appid" : "wxd7de467f6e6cf741",
        "cloudfunctionRoot": "./functions/", // 这一行就是标记云函数目录的字段
        "setting" : {
            "urlCheck" : false
        },
        "usingComponents" : true
    }
</code></pre>
<h2 id="编写vueconfigjs">编写<code>vue.config.js</code></h2>
<ol>
<li>我们在项目根目录创建<code>vue.config.js</code>文件</li>
<li>写入以下内容（如路径不一样请做相应适配）<br>```javascript<br>const path = require('path')<br>const CopyWebpackPlugin = require('copy-webpack-plugin')</li>
</ol>
<p>module.exports = {<br>    configureWebpack: {<br>        plugins: [<br>            new CopyWebpackPlugin([{<br>                from: path.join(__dirname, 'cloudFunctions'),<br>                to: path.join(__dirname, 'unpackage/dist', process.env.NODE_ENV === 'production' ? 'build' : 'dev', process.env<br>                    .UNI_PLATFORM, 'cloudFunctions')<br>            }])<br>        ]<br>    }<br>}</p>
<pre><code>3. 编译运行

发现提示如下内容

![提示内容][3]

说明未安装`copy-webpack-plugin`插件，我们手动安装一下。
```shell
npm install -save copy-webpack-plugin
</code></pre>
<blockquote>
<p>TIPS: 截至2020.6.4， uni-app暂不支持copy-webpack-plugin 6.0版，请安装5.0版</p>
</blockquote>
<p><img src="https://blog.cdn.thinkmoon.cn/blog/typecho/2019-10-22T01:34:09.png" alt="安装copy-webpack-plugin"></p>
<p>然后编译运行，发现微信开发者工具里面出现以下内容。</p>
<p><img src="https://blog.cdn.thinkmoon.cn/blog/typecho/2019-10-22T01:35:15.png" alt="微信开发者工具里面的内容"></p>
<hr>
<p>截止目前，已打通Hbuilder X到微信开发者工具的自动复制，即已解决本文的核心内容。以下为进一步测试。</p>
<h2 id="创建云函数">创建云函数</h2>
<blockquote>
<p>我们在云函数根目录上右键，在右键菜单中，可以选择创建一个新的 Node.js 云函数，我们将该云函数命名为check。开发者工具在本地创建出云函数目录和入口 index.js 文件，同时在线上环境中创建出对应的云函数。创建成功后，工具会提示是否立即本地安装依赖，确定后工具会自动安装 wx-server-sdk。我们会看到以下内容。</p>
</blockquote>
<p>创建好后将其同步复制到uni-app项目，即可为以后自动同步行方便，又可避免在输出文件夹中云函数的意外丢失。至此，相关文件编写工作转至<code>Hbuilder X</code>，云函数上传部署依旧在微信开发者工具。</p>
<p><img src="https://blog.cdn.thinkmoon.cn/blog/typecho/2019-10-22T01:45:21.png" alt="云函数模板内容"></p>
<h2 id="编写云函数">编写云函数</h2>
<p>默认的云函数只是一个返回用户基本数据的内容，我们将其修改至满足我们的业务需求，以内容安全云调用为例。</p>
<p>在云函数文件中写入以下内容</p>
<pre><code class="language-javascript">// 云函数入口文件
const cloud = require('wx-server-sdk')

cloud.init()

// 云函数入口函数
exports.main = async(event, context) => {
  try {
    console.log('待检测文本:' + event.content);
    let result = await cloud.openapi.security.msgSecCheck({
      content: event.content
    })
    console.log('result:' + JSON.stringify(result));

    if (result && result.errCode.toString() === '87014') {
      return {
        code: 300,
        msg: '内容含有违法违规内容',
        data: result
      }
    } else {
      return {
        code: 200,
        msg: 'ok',
        data: result
      }
    }

  } catch (err) {
    if (err.errCode.toString() === '87014') {
      return {
        code: 300,
        msg: '内容含有违法违规内容',
        data: err
      }
    }
    return {
      code: 400,
      msg: '调用security接口异常',
      data: err
    }
  }
}
</code></pre>
<h2 id="权限申明">权限申明</h2>
<p><img src="https://blog.cdn.thinkmoon.cn/blog/typecho/2019-12-10T06:54:47.png" alt="云函数config权限声明"></p>
<p>如上图，在函数目录下，创建一个<code>config.json</code>,文档说会自动创建，但是我实际操作时未自动创建。<code>config.json</code>内容如下。</p>
<pre><code class="language-json">{
    "permissions": {
        "openapi": [
            "security.msgSecCheck"
        ]
    }
}
</code></pre>
<p>然后在函数目录右键，上传并部署。</p>
<h2 id="小程序调用云函数">小程序调用云函数</h2>
<h3 id="appvue">App.vue</h3>
<pre><code class="language-javascript">&lt;script>
  export default {
    onLaunch() {
      wx.cloud.init();
    }
  }
&lt;/script>
</code></pre>
<h3 id="indexvue">index.vue</h3>
<pre><code class="language-javascript">let res = await wx.cloud.callFunction({
          name: 'checkText',
          data: {
            "content": this.displayString
          }
        })
        if (res.result.code != 200) {
          uni.showModal({
            title: "温馨提示",
            content: "你所输入的内容可能含有违法违规内容，不支持进行下一步操作"
          })
          return
        }
</code></pre>
<h2 id="效果展示">效果展示</h2>
<p><img src="https://blog.cdn.thinkmoon.cn/blog/typecho/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191022110949.png" alt="微信图片_20191022110949.png"></p>
</div></div></div></div></div></div><script defer src="/_nuxt/static/1619942794/post/466/state.js"></script><script src="/_nuxt/b0f8911.js" defer></script><script src="/_nuxt/fc6b942.js" defer></script><script src="/_nuxt/a1b9b3d.js" defer></script><script src="/_nuxt/02b3e78.js" defer></script>
</body>
<script defer>hljs.highlightAll()</script>
</html>
