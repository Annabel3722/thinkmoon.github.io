<!doctype html>
<html data-n-head-ssr lang="zh-CN" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22zh-CN%22%7D%7D">
<head>
  <title>el-upload视频上传支持回显和预览的一种异教徒解决方案</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta data-n-head="ssr" data-hid="keywords" name="keywords" content="thinkmoon,醉月思,指尖魔法屋"><meta data-n-head="ssr" data-hid="description" name="description" content="总结与记录是两个极其优秀的学习习惯！"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="/highlight/atom-one-dark.min.css"><link data-n-head="ssr" rel="stylesheet" href="/style.css"><script data-n-head="ssr" src="/highlight/highlight.min.js"></script><link rel="preload" href="/_nuxt/e4b7d96.js" as="script"><link rel="preload" href="/_nuxt/fc6b942.js" as="script"><link rel="preload" href="/_nuxt/css/edb8de7.css" as="style"><link rel="preload" href="/_nuxt/623b5d2.js" as="script"><link rel="preload" href="/_nuxt/746647a.js" as="script"><link rel="stylesheet" href="/_nuxt/css/edb8de7.css"><link rel="preload" href="/_nuxt/static/1620746793/post/861/state.js" as="script"><link rel="preload" href="/_nuxt/static/1620746793/post/861/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1620746793/manifest.js" as="script">
</head>
<body>
<div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div class="container"><div class="article-content"><h1 class="article-title">
      el-upload视频上传支持回显和预览的一种异教徒解决方案
    </h1> <div><blockquote>
<p>该文章为异教徒解决方案，各位看官看下即可，切勿模仿！！！</p>
</blockquote>
<h2 id="问题描述">问题描述</h2>
<p>原生的el-upload只支持上传图片时候的预览和回显，这是因为只针对img标签做了适配，如下图。</p>
<p><img src="http://blog.cdn.thinkmoon.cn/blog/typecho/2020-06-03T05:42:34.png" alt="2020-06-03T05:42:34.png"></p>
<p>而如果我们上传视频，则会出现一个白方框，用户体验不佳。</p>
<p><img src="http://blog.cdn.thinkmoon.cn/blog/typecho/2020-06-03T05:45:07.png" alt="2020-06-03T05:45:07.png"></p>
<h2 id="解决思路">解决思路</h2>
<p>其实正确的解决思路应该是</p>
<ol>
<li>将<code>show-file-list</code>属性设置为<code>false</code>。然后再自己循环显示file-list，以及追加对应的预览，删除按钮及功能。</li>
<li>设置自定义模板内容(推荐使用)</li>
</ol>
<p>但是我觉得这样太麻烦了(时间问题）。</p>
<p>于是我突发奇想，如果我将img标签改成video标签呢？如下图</p>
<p><img src="http://blog.cdn.thinkmoon.cn/blog/typecho/2020-06-03T05:46:56.png" alt="2020-06-03T05:46:56.png"></p>
<p>发现居然完美契合，毫无违和感。</p>
<h2 id="预览的实现">预览的实现</h2>
<p>在做到把img改为video标签之前，还需要解决的另一个问题就是，如何让视频也支持预览。老规矩，我们先来看看官方Demo怎么实现预览的。</p>
<p><img src="http://blog.cdn.thinkmoon.cn/blog/typecho/2020-06-03T05:54:03.png" alt="2020-06-03T05:54:03.png"></p>
<p>官方的做法是增加一个dialog，然后在点击预览图片时将文件url传给dialog。我们先来实现一下改写一下dialog</p>
<pre><code class="language-vue">&lt;el-dialog :visible.sync="dialogVisible" :modal-append-to-body="true">
      &lt;video width="100%" muted autoplay="autoplay" loop="loop" v-if="dialogImageUrl[dialogImageUrl.length - 1] == 4" :src="dialogImageUrl">&lt;/video>
      &lt;img width="100%" v-else :src="dialogImageUrl" alt />
    &lt;/el-dialog>
</code></pre>
<blockquote>
<p>tips: 我这种判断MP4格式的方式实属异端，不建议模仿。</p>
</blockquote>
<h2 id="替换img标签">替换img标签</h2>
<p>一到标签节点的操作，我第一想到的就是document操作（异端+1），直接上代码。</p>
<pre><code class="language-javascript"> changeVideoTag(){
      let videoTag = document.querySelector('.video img')
      console.log('检测到应为video的img标签', videoTag)
      if(videoTag){
        let parentNode = videoTag.parentNode
        let newElement = document.createElement('video')
        newElement.setAttribute('class', videoTag.getAttribute('class'))
        newElement.setAttribute('src', videoTag.getAttribute('src'))
        parentNode.insertBefore(newElement, videoTag)
      }
    },
</code></pre>
<p>该函数负责寻找video类下的img标签，然后在img标签之前，添加一个同样的videos元素节点，此处你可以选择是否移除原img标签。</p>
<h2 id="最终实现效果">最终实现效果</h2>
<p><img src="http://blog.cdn.thinkmoon.cn/blog/typecho/gif.gif" alt="gif.gif"></p>
<h2 id="最后的话">最后的话</h2>
<ol>
<li>这种方法非常不推荐使用，强烈建议使用自定义模板缩略图</li>
<li>这种方法非常不推荐使用，强烈建议使用自定义模板缩略图</li>
<li>这种方法非常不推荐使用，强烈建议使用自定义模板缩略图</li>
</ol>
</div></div></div></div></div></div><script defer src="/_nuxt/static/1620746793/post/861/state.js"></script><script src="/_nuxt/e4b7d96.js" defer></script><script src="/_nuxt/fc6b942.js" defer></script><script src="/_nuxt/623b5d2.js" defer></script><script src="/_nuxt/746647a.js" defer></script>
</body>
<script defer>hljs.highlightAll()</script>
</html>
