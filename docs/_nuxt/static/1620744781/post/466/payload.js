__NUXT_JSONP__("/post/466", (function(a,b){return {data:[{article:{cid:466,title:"uni-app对微信小程序云函数的适配",slug:"474",created:1571716380,modified:1591258324,text:"\u003C!--markdown--\u003E## 引言\r\n\r\n熟悉uni-app的人应该都知道，uni-app并未对微信小程序云函数（本文统称云函数）进行相应的适配。但是，如果我们在某些业务场景的下需要使用云函数呢？我们知道，云函数可以复制到微信开发者工具，这样的话我们不得不每次编译一次就手动复制一次，不得不说麻烦至极。本文就问题做出以下解决方案。\r\n\r\n### 本文环境\r\n1. Hbuilder X\r\n\r\n![Hbuilder X版本][1]\r\n\r\n2. 微信开发者工具\r\n\r\n![微信开发者工具版本][2]\r\n\r\n## 创建云函数目录\r\n\r\n首先，我们需要在uni-app项目文件夹下，创建一个云函数目录，路径随意，我这里是`functions`。然后先随便在里面放一些文件，这里以`new_file.css`为例。\r\n\r\n## 修改`manifest.json`\r\n\r\n在uni-app根目录下，修改`manifest.json`中的微信小程序项，结构如下\r\n```json\r\n\"mp-weixin\" : {\r\n        \u002F* 小程序特有相关 *\u002F\r\n        \"appid\" : \"wxd7de467f6e6cf741\",\r\n        \"cloudfunctionRoot\": \".\u002Ffunctions\u002F\", \u002F\u002F 这一行就是标记云函数目录的字段\r\n        \"setting\" : {\r\n            \"urlCheck\" : false\r\n        },\r\n        \"usingComponents\" : true\r\n    }\r\n```\r\n\r\n## 编写`vue.config.js`\r\n\r\n1. 我们在项目根目录创建`vue.config.js`文件\r\n2. 写入以下内容（如路径不一样请做相应适配）\r\n```javascript\r\nconst path = require('path')\r\nconst CopyWebpackPlugin = require('copy-webpack-plugin')\r\n\r\nmodule.exports = {\r\n\tconfigureWebpack: {\r\n\t\tplugins: [\r\n\t\t\tnew CopyWebpackPlugin([{\r\n\t\t\t\tfrom: path.join(__dirname, 'cloudFunctions'),\r\n\t\t\t\tto: path.join(__dirname, 'unpackage\u002Fdist', process.env.NODE_ENV === 'production' ? 'build' : 'dev', process.env\r\n\t\t\t\t\t.UNI_PLATFORM, 'cloudFunctions')\r\n\t\t\t}])\r\n\t\t]\r\n\t}\r\n}\r\n\r\n```\r\n3. 编译运行\r\n\r\n发现提示如下内容\r\n\r\n![提示内容][3]\r\n\r\n说明未安装`copy-webpack-plugin`插件，我们手动安装一下。\r\n```shell\r\nnpm install -save copy-webpack-plugin\r\n```\r\n\u003E TIPS: 截至2020.6.4， uni-app暂不支持copy-webpack-plugin 6.0版，请安装5.0版\r\n\r\n![安装copy-webpack-plugin][4]\r\n\r\n然后编译运行，发现微信开发者工具里面出现以下内容。\r\n\r\n![微信开发者工具里面的内容][5]\r\n\r\n---\r\n\r\n截止目前，已打通Hbuilder X到微信开发者工具的自动复制，即已解决本文的核心内容。以下为进一步测试。\r\n\r\n## 创建云函数\r\n\r\n\u003E 我们在云函数根目录上右键，在右键菜单中，可以选择创建一个新的 Node.js 云函数，我们将该云函数命名为check。开发者工具在本地创建出云函数目录和入口 index.js 文件，同时在线上环境中创建出对应的云函数。创建成功后，工具会提示是否立即本地安装依赖，确定后工具会自动安装 wx-server-sdk。我们会看到以下内容。\r\n\r\n创建好后将其同步复制到uni-app项目，即可为以后自动同步行方便，又可避免在输出文件夹中云函数的意外丢失。至此，相关文件编写工作转至`Hbuilder X`，云函数上传部署依旧在微信开发者工具。\r\n\r\n![云函数模板内容][6]\r\n\r\n## 编写云函数\r\n\r\n默认的云函数只是一个返回用户基本数据的内容，我们将其修改至满足我们的业务需求，以内容安全云调用为例。\r\n\r\n在云函数文件中写入以下内容\r\n\r\n```javascript\r\n\u002F\u002F 云函数入口文件\r\nconst cloud = require('wx-server-sdk')\r\n\r\ncloud.init()\r\n\r\n\u002F\u002F 云函数入口函数\r\nexports.main = async(event, context) =\u003E {\r\n  try {\r\n    console.log('待检测文本:' + event.content);\r\n    let result = await cloud.openapi.security.msgSecCheck({\r\n      content: event.content\r\n    })\r\n    console.log('result:' + JSON.stringify(result));\r\n\r\n    if (result && result.errCode.toString() === '87014') {\r\n      return {\r\n        code: 300,\r\n        msg: '内容含有违法违规内容',\r\n        data: result\r\n      }\r\n    } else {\r\n      return {\r\n        code: 200,\r\n        msg: 'ok',\r\n        data: result\r\n      }\r\n    }\r\n\r\n  } catch (err) {\r\n    if (err.errCode.toString() === '87014') {\r\n      return {\r\n        code: 300,\r\n        msg: '内容含有违法违规内容',\r\n        data: err\r\n      }\r\n    }\r\n    return {\r\n      code: 400,\r\n      msg: '调用security接口异常',\r\n      data: err\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n## 权限申明\r\n\r\n![云函数config权限声明][7]\r\n\r\n如上图，在函数目录下，创建一个`config.json`,文档说会自动创建，但是我实际操作时未自动创建。`config.json`内容如下。\r\n\r\n```json\r\n{\r\n\t\"permissions\": {\r\n\t\t\"openapi\": [\r\n\t\t\t\"security.msgSecCheck\"\r\n\t\t]\r\n\t}\r\n}\r\n\r\n```\r\n\r\n然后在函数目录右键，上传并部署。\r\n\r\n## 小程序调用云函数\r\n\r\n### App.vue\r\n\r\n```javascript\r\n\u003Cscript\u003E\r\n  export default {\r\n    onLaunch() {\r\n      wx.cloud.init();\r\n    }\r\n  }\r\n\u003C\u002Fscript\u003E\r\n```\r\n### index.vue\r\n\r\n```javascript\r\nlet res = await wx.cloud.callFunction({\r\n          name: 'checkText',\r\n          data: {\r\n            \"content\": this.displayString\r\n          }\r\n        })\r\n        if (res.result.code != 200) {\r\n          uni.showModal({\r\n            title: \"温馨提示\",\r\n            content: \"你所输入的内容可能含有违法违规内容，不支持进行下一步操作\"\r\n          })\r\n          return\r\n        }\r\n```\r\n\r\n## 效果展示\r\n\r\n![微信图片_20191022110949.png][8]\r\n\r\n\r\n  [1]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002Fblog\u002Ftypecho\u002F2019-10-22T01:28:39.png\r\n  [2]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002Fblog\u002Ftypecho\u002F2019-10-22T01:32:01.png\r\n  [3]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002Fblog\u002Ftypecho\u002F2019-10-22T01:18:43.png\r\n  [4]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002Fblog\u002Ftypecho\u002F2019-10-22T01:34:09.png\r\n  [5]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002Fblog\u002Ftypecho\u002F2019-10-22T01:35:15.png\r\n  [6]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002Fblog\u002Ftypecho\u002F2019-10-22T01:45:21.png\r\n  [7]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002Fblog\u002Ftypecho\u002F2019-12-10T06:54:47.png\r\n  [8]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002Fblog\u002Ftypecho\u002F%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191022110949.png",order:b,authorId:1,type:"post",status:"publish",commentsNum:10,allowComment:a,allowPing:a,allowFeed:a,parent:b,views:1805,likes:6}}],fetch:{},mutations:void 0}}("1",0)));