__NUXT_JSONP__("/post/849", (function(a,b){return {data:[{article:{cid:849,title:"gitlab中vue前端项目CI\u002FCD部署笔记",slug:"849",created:1590129840,modified:1592912088,text:"\u003C!--markdown--\u003E## 持续集成\r\n\r\n略\r\n\r\n## Gitlab的持续集成\r\n\r\n我们可以将整个运行机制，看作一个赏金猎人接任务，执行任务，并完成任务的过程。\r\n\r\n### GitLab-CI\r\n\r\n简单来说，这就是一个任务发布平台。运行在gitlab服务器，监听代码状态变化，并发布对应的任务。\r\n\r\n### GitLab-Runner\r\n\r\n而每个runner就是一位赏金猎人，是任务的执行者。\r\n\r\n![2020-05-22T06:04:52.png][1]\r\n\r\n### .gitlab-ci.yml\r\n\r\n任务的发布者，规定什么时候触发任务，任务的具体内容。\r\n\r\n## 配置流程\r\n\r\n经过前面的解释，整个思路就很清晰了。我们需要做的有三件事。\r\n\r\n1. 编写`.gitlab-ci.yml`文件，设置对应的任务\r\n2. 部署Runner，激活赏金猎人\r\n3. 配置ci，邀请赏金猎人加入系统\r\n\r\n### 部署Runner\r\n\r\n这一步需要一个服务器，能run起来赏金猎人。\r\n\r\n#### 安装\r\n\r\n请务必安装最新版，不然会出现很多未知的问题\r\n\r\n1. 下载二进制文件\r\n```bash\r\n# Linux x86-64\r\nsudo curl -L --output \u002Fusr\u002Flocal\u002Fbin\u002Fgitlab-runner https:\u002F\u002Fgitlab-runner-downloads.s3.amazonaws.com\u002Flatest\u002Fbinaries\u002Fgitlab-runner-linux-amd64\r\n\r\n# Linux x86\r\nsudo curl -L --output \u002Fusr\u002Flocal\u002Fbin\u002Fgitlab-runner https:\u002F\u002Fgitlab-runner-downloads.s3.amazonaws.com\u002Flatest\u002Fbinaries\u002Fgitlab-runner-linux-386\r\n\r\n# Linux arm\r\nsudo curl -L --output \u002Fusr\u002Flocal\u002Fbin\u002Fgitlab-runner https:\u002F\u002Fgitlab-runner-downloads.s3.amazonaws.com\u002Flatest\u002Fbinaries\u002Fgitlab-runner-linux-arm\r\n\r\n# Linux arm64\r\nsudo curl -L --output \u002Fusr\u002Flocal\u002Fbin\u002Fgitlab-runner https:\u002F\u002Fgitlab-runner-downloads.s3.amazonaws.com\u002Flatest\u002Fbinaries\u002Fgitlab-runner-linux-arm64\r\n```\r\n\r\n2. 授予执行权限\r\n\r\n```bash\r\nsudo chmod +x \u002Fusr\u002Flocal\u002Fbin\u002Fgitlab-runner\r\n```\r\n\r\n3. Create a GitLab CI user:\r\n\r\n```bash\r\nsudo useradd --comment 'GitLab Runner' --create-home gitlab-runner --shell \u002Fbin\u002Fbash\r\n```\r\n\r\n4. Install and run as service:\r\n\r\n```bash\r\nsudo gitlab-runner install --user=gitlab-runner --working-directory=\u002Fhome\u002Fgitlab-runner\r\nsudo gitlab-runner start\r\n```\r\n\r\n#### 加入任务系统\r\n\r\n注册\r\n\r\n```bash\r\nsudo gitlab-runner register\r\n```\r\n\r\n然后就是一些简单的配置，配置完成后就将该Runner注册到任务发布平台了，然后就可以接任务了。详细见参考文献【1】\r\n\r\n\r\n#### 编写.gitlab-ci.yml任务\r\n\r\n本机部署版本\r\n.gitlab-ci.yml\r\n```yml\r\nstages:\r\n  - deploy\r\n\r\ncache:\r\n  paths:\r\n    - node_modules\u002F\r\n    - public\u002F\r\n\r\ndeployJob:\r\n  stage: deploy \r\n  script:\r\n    - npm install \r\n    - npm run build\r\n    - rm -rf \u002Fhome\u002Fdata\u002Fthree_miju_shopper_manager_system_front\u002F*\r\n    - cp -rf .\u002Fdist\u002F* \u002Fhome\u002Fdata\u002Fthree_miju_shopper_manager_system_front\u002F\r\n    - sh .\u002Fbot.sh ${CI_COMMIT_REF_SLUG} ${CI_COMMIT_SHA:0:8} ${CI_COMMIT_MESSAGE}\r\n  tags:\r\n    - shared_test_machine_runner\r\n  only:\r\n    - dev\r\n```\r\n这个版本具有企业微信群机器人推送功能，需要配置`.\u002Fbot.sh`\r\n```shell\r\n#!\u002Fusr\u002Fbin\u002Fenv bash\r\ncurl '群机器人地址' \\\r\n      -H 'Content-Type: application\u002Fjson' \\\r\n      -d '\r\n      {\r\n        \"msgtype\": \"markdown\",\r\n        \"markdown\": {\r\n          \"content\": \"商户端代码已更新，分支:'$1' 提交:'$2'\r\n          更新：'$3'\r\n          已发布，[点击测试](http:\u002F\u002Ftest.shop.gileey.cn)\"\r\n        }\r\n      }'\r\n```\r\n远程推送版本\r\n```shell\r\nstages:\r\n  - deploy\r\n\r\ncache:\r\n  paths:\r\n    - node_modules\u002F\r\n    - public\u002F\r\n\r\ndeployJob:\r\n  stage: deploy \r\n  script:\r\n    - mkdir -p ~\u002F.ssh\r\n    - echo \"$SSH_PRIVATE_KEY\" \u003E\u003E ~\u002F.ssh\u002Fid_dsa\r\n    - chmod 600 ~\u002F.ssh\u002Fid_dsa\r\n    - echo -e \"Host *\\n\\tStrictHostKeyChecking no\\n\\n\" \u003E ~\u002F.ssh\u002Fconfig\r\n    - rsync -avzu --progress .\u002Fdist\u002F* root@thinkmoon.cn:\u002Fwww\u002Fwwwroot\u002F3ju.psyannabel.cn\u002F\r\n  tags:\r\n    - shared_test_machine_runner\r\n  only:\r\n    - dev\r\n```\r\n该版本在gitlab-runner机器上执行编译等工作，编译完成后使用rsync同步到云服务器，需要配置私钥变量`$SSH_PRIVATE_KEY`\r\n\r\n![2020-05-30T14:20:12.png][2]\r\n\r\n## 遇到的问题\r\n\r\n导入自定义组件时一直报错：`This dependency was not found:`\r\n\r\n出现背景：由于以前命名组件是\"clickImg\",后改成\"ClickImg\",由于linux的区分大小写，所以会一直没找到。\r\n\r\n解决方案：换个名字？？？\r\n\r\n## 参考文献\r\n\r\n1. [前端的gitlab的ci初尝试](https:\u002F\u002Fjuejin.im\u002Fpost\u002F5b03963a51882542821ca56a)\r\n2. [Install GitLab Runner manually on GNU\u002FLinux](https:\u002F\u002Fdocs.gitlab.com\u002Frunner\u002Finstall\u002Flinux-manually.html)\r\n\r\n\r\n  [1]: http:\u002F\u002Fblog.cdn.thinkmoon.cn\u002Fblog\u002Ftypecho\u002F2020-05-22T06:04:52.png\r\n  [2]: http:\u002F\u002Fblog.cdn.thinkmoon.cn\u002Fblog\u002Ftypecho\u002F2020-05-30T14:20:12.png",order:b,authorId:1,type:"post",status:"publish",commentsNum:3,allowComment:a,allowPing:a,allowFeed:a,parent:b,views:1547,likes:2}}],fetch:{},mutations:void 0}}("1",0)));