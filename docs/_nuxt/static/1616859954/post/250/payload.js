__NUXT_JSONP__("/post/250", {data:[{article:"\u003C!--markdown--\u003E## 引言\n\u003Cp\u003E我在很久之前就想研究这个项目，然后再进行些自定义的修改了。就以本文作为笔记开始吧。\u003C\u002Fp\u003E\n\u003Ch2 id=\"项目目录树\"\u003E项目目录树\u003C\u002Fh2\u003E\n\u003Cpre\u003E\u003Ccode\u003E.\n├── Action.php\n├── Plugin.php\n├── Users.php\n├── res \u002F\u002F一些图片资源\n│   ├── cvbg.jpeg\n│   ├── cvborder.jpeg\n│   ├── resend.png\n│   └── test.bin\n├── sql \u002F\u002F 创建了两个数据库\n│   ├── wetypecho.sql\n│   └── wetypecholike.sql\n└── tree.txt\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 id=\"查看数据库结构\"\u003E查看数据库结构\u003C\u002Fh2\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003Ewetypecho.sql\u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n\u003Cpre\u003E\u003Ccode\u003ECREATE TABLE `typecho_wetypecho` (\n  `id`                int(10) unsigned NOT NULL auto_increment,\n  `openid`            varchar(255)     default &#39;&#39;  ,\n  `createtime`        int(10)          default 0   ,\n  `lastlogin`         int(10)          default 0   ,\n  `nickname`          varchar(255)     default &#39;&#39;  ,\n  `avatarUrl`         varchar(255)      default &#39;&#39;  ,\n  `city`              varchar(255)      default &#39;&#39;  ,\n  `country`           varchar(255)      default &#39;&#39;  ,\n  `gender`            varchar(255)      default &#39;&#39;  ,\n  `province`          varchar(255)     default &#39;&#39;  ,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E看内容可以推测，这是微信用户数据表。\u003C\u002Fp\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003Ewetypecholike.sql\u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n\u003Cpre\u003E\u003Ccode\u003ECREATE TABLE `typecho_wetypecholike` (\n  `id`                int(10) unsigned NOT NULL auto_increment,\n  `openid`            varchar(255)     default &#39;&#39;  ,\n  `cid`               int(10)          default 0   ,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E这应该是个微信点赞表\u003C\u002Fp\u003E\n\u003Ch2 id=\"php代码分析\"\u003Ephp代码分析\u003C\u002Fh2\u003E\n\u003Cp\u003E激活进行的初始化操作代码\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003EHelper::addRoute(&#39;jsonp&#39;, &#39;\u002Fapi\u002F[type]&#39;, &#39;WeTypecho_Action&#39;);\n        Helper::addAction(&#39;json&#39;, &#39;WeTypecho_Action&#39;);\n        Helper::removePanel(1, &#39;WeTypecho\u002Fusers.php&#39;);\n        Helper::addPanel(1, &#39;WeTypecho\u002FUsers.php&#39;, &#39;WeTypecho&#39;, &#39;我的用户&#39;, &#39;administrator&#39;);\n        $db = Typecho_Db::get();\n        $prefix = $db-&gt;getPrefix();\n        Typecho_Plugin::factory(&#39;Widget_Archive&#39;)-&gt;beforeRender = array(&#39;WeTypecho_Plugin&#39;,&#39;view_count&#39;);\n        \u002F\u002F创建用户数据库\n        $scripts = file_get_contents(&#39;usr\u002Fplugins\u002FWeTypecho\u002Fsql\u002Fwetypecho.sql&#39;);\n        $scripts = str_replace(&#39;typecho_&#39;, $prefix, $scripts);\n        $scripts = explode(&#39;;&#39;, $scripts);\n        try {\n            if (!$db-&gt;fetchRow($db-&gt;query(&quot;SHOW TABLES LIKE &#39;{$prefix}wetypecho&#39;;&quot;, Typecho_Db::READ))) {\n                foreach ($scripts as $script) {\n                    $script = trim($script);\n                    if ($script) {\n                        $db-&gt;query($script, Typecho_Db::WRITE);\n                    }\n                }\n            }\n        } catch (Typecho_Db_Exception $e) {\n            throw new Typecho_Plugin_Exception(_t(&#39;数据表建立失败，插件启用失败，错误信息：%s。&#39;, $e-&gt;getMessage()));\n        } catch (Exception $e) {\n            throw new Typecho_Plugin_Exception($e-&gt;getMessage());\n        }\n        \u002F\u002F创建赞数据库\n        $scriptslike = file_get_contents(&#39;usr\u002Fplugins\u002FWeTypecho\u002Fsql\u002Fwetypecholike.sql&#39;);\n        $scriptslike = str_replace(&#39;typecho_&#39;, $prefix, $scriptslike);\n        $scriptslike = explode(&#39;;&#39;, $scriptslike);\n        try {\n            if (!$db-&gt;fetchRow($db-&gt;query(&quot;SHOW TABLES LIKE &#39;{$prefix}wetypecholike&#39;;&quot;, Typecho_Db::READ))) {\n                foreach ($scriptslike as $script) {\n                    $script = trim($script);\n                    if ($script) {\n                        $db-&gt;query($script, Typecho_Db::WRITE);\n                    }\n                }\n            }\n        } catch (Typecho_Db_Exception $e) {\n            throw new Typecho_Plugin_Exception(_t(&#39;数据表建立失败，插件启用失败，错误信息：%s。&#39;, $e-&gt;getMessage()));\n        } catch (Exception $e) {\n            throw new Typecho_Plugin_Exception($e-&gt;getMessage());\n        }\n        \u002F\u002F创建赞数据库\n        try {\n            \u002F\u002F增加点赞和阅读量\n            if (!array_key_exists(&#39;views&#39;, $db-&gt;fetchRow($db-&gt;select()-&gt;from(&#39;table.contents&#39;))))\n            {\n                $db-&gt;query(\n                    &#39;ALTER TABLE `&#39; . $prefix\n                    . &#39;contents` ADD `views` INT DEFAULT 0;&#39;\n                );\n            }\n            if (!array_key_exists(&#39;likes&#39;, $db-&gt;fetchRow($db-&gt;select()-&gt;from(&#39;table.contents&#39;))))\n            {\n                $db-&gt;query(\n                    &#39;ALTER TABLE `&#39; . $prefix\n                    . &#39;contents` ADD `likes` INT DEFAULT 0;&#39;\n                );\n            }\n            if (!array_key_exists(&#39;authorImg&#39;, $db-&gt;fetchRow($db-&gt;select()-&gt;from(&#39;table.comments&#39;))))\n            {\n                $db-&gt;query(\n                    &#39;ALTER TABLE `&#39; . $prefix\n                    . &#39;comments` ADD `authorImg` varchar(500) DEFAULT NULL;&#39;\n                );\n            }\n        } catch (Exception $e) {\n            echo($e-&gt;getMessage());\n        }\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n"}],fetch:{},mutations:void 0});