__NUXT_JSONP__("/post/530", (function(a,b){return {data:[{article:{cid:530,title:"自建网站对接微信公众号",slug:"530",created:1523517900,modified:1572255560,text:"\u003C!--markdown--\u003E\u003E 平常我们有些写各种网站, 个人博客系统, 物流管理系统, 通信录管理系统, 校园二手网站. 我们都知道, 只需要租用一个服务器, 再配置一个备案好的域名, 就可以在浏览器上进行访问了.\r\n\u003E 不知大家, 不知大家有没有想过, 将你搭的网站对接微信公众号, 利用微信这个大用户软件, 来为你引流呢? \r\n\u003C!-- more --\u003E\r\n***\r\n|  本文环境  |  版本  | \r\n| --- | --- | \r\n| 操作系统 |  Ubuntu 16.04.03   | \r\n| 运行方式 | VMware虚拟机   |  \r\n| 编程语言 | PHP |\r\n| 项目局域网地址 | http:\u002F\u002F192.168.253.1\u002Faudit |\r\n***\r\n \r\n\r\n![enter description here][1]\r\n\r\n\r\n Q: 你在搞笑吗? 不是直接在微信里面打开的吗?\r\n\r\n\u003E A: 直接用微信打开是可以, 然后你在微信里面让用户再注册一个账号? 对于大部分不想麻烦的小伙伴来说, 他们会对此忘而却步. 其实微信是提供接口, 让你可以获取到微信的用户名,和用户头像的. \r\n\r\n## 一般来说分为三种情况\r\n\r\n1. 使用通过的微信**开放**平台( 注意,不是微信公众平台) \r\n\u003E 需要开发者认证\r\n\r\n2. 使用认证过的订阅号.\r\n\u003E 需要微信认证\r\n\r\n3. 使用认证过的服务号\r\n\r\n\u003E 需要微信认证\r\n\r\n## 额, 那其实不是没认证就没得玩? \r\n\u003E 好吧, 实际是的确如此, 不过. 如果你真的只是想玩玩. 你可以去这儿. https:\u002F\u002Fmp.weixin.qq.com\u002Fdebug\u002Fcgi-bin\u002Fsandbox?t=sandbox\u002Flogin\r\n\r\n![enter description here][2]\r\n\r\n\u003E 微信测试号\r\n\u003E ### 优点\r\n\u003E -  拥有几乎所有接口, \r\n\u003E -  以及享受局域网IP回调(意思就是说,可以支持局域网, 这是正式微信平台号所不具备的)\r\n\u003E - 发送模板消息, 不用审核.\r\n\u003E ### 缺点\r\n\u003E - 只支持最多100个用户\r\n\u003E - 不能设置名称, 头像.\r\n\r\n\u003E 对于一些只是想玩玩, 或者小规模用户的是没有问题的.\r\n\r\n### 跟我一起操作\r\n\r\n#### 登录\r\n\u003E 扫码登录就好了;\r\n\r\n#### 微信token\r\n\u003E 新建php文件(啥语言都可以,自行修改)\r\n```php\r\npublic function token()\r\n    {\r\n        $nonce = $_GET['nonce'];\r\n        $token = 'weixin';\r\n        $timestamp = $_GET['timestamp'];\r\n        $echostr = $_GET['echostr'];\r\n        $signature = $_GET['signature'];\r\n        \u002F\u002F形成数组，然后按字典序排序\r\n        $array = array();\r\n        $array = array($nonce, $timestamp, $token);\r\n        sort($array);\r\n        \u002F\u002F拼接成字符串,sha1加密 ，然后与signature进行校验\r\n        $str = sha1(implode($array));\r\n        if ($str == $signature && $echostr) {\r\n            \u002F\u002F第一次接入weixin api接口的时候\r\n            echo $echostr;\r\n            exit;\r\n        }\r\n    }\r\n```\r\n\u003E 然后在测试号里填写路径和token, 认证成功后就可以继续操作了\r\n\r\n![enter description here][3]\r\n\r\n\u003E TIP: 这个链接并不需要一直可访问,**只需要第一次认证通过就OK**, 甚至认证过可以直接删掉.\r\n\r\n### 修改回调域名, 接口\u003E 网页授权获取用户基本信息 \u003E 修改\r\n![enter description here][4]\r\n\u003E **只有测试号支持ip**\r\n### 微信的接口\r\n\u003E 接口详情可在*https:\u002F\u002Fmp.weixin.qq.com\u002Fwiki?t=resource\u002Fres_main&id=mp1421141013*里查看\r\n\r\n\u003E**注意**: \r\n\u003E1. 这些接口不是简单的对接就好了, 每次请求都需要携带access_token,\r\n\u003E2.  而获取access_token, 每天有获取上限.\r\n\u003E3. access-token具有有效期(7200s) , 过期需要重新获取. \r\n\r\n\u003E 获取access_token的方法*https:\u002F\u002Fmp.weixin.qq.com\u002Fdebug\u002Fcgi-bin\u002Fapiinfo?t=index&type=%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81&form=%E8%8E%B7%E5%8F%96access_token%E6%8E%A5%E5%8F%A3%20\u002Ftoken*\r\n\r\n### 获取用户信息, 实现免登录的效果\r\n\r\n![enter description here][5]\r\n\r\n\u003E 在这儿我们需要三个接口\r\n#### 所用接口:\r\n\u003E 接口一: \r\n*`https:\u002F\u002Fopen.weixin.qq.com\u002Fconnect\u002Foauth2\u002Fauthorize?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect`*\r\n\u003E 接口二:\r\n*`https:\u002F\u002Fapi.weixin.qq.com\u002Fsns\u002Foauth2\u002Faccess_token?appid=APPID&secret=SECRET&code=CODE&grant_type=authorization_code`*\r\n\u003E 接口三:\r\n*`https:\u002F\u002Fapi.weixin.qq.com\u002Fsns\u002Fuserinfo?access_token=ACCESS_TOKEN&openid=OPENID&lang=zh_CN`*\r\n\u003E 接口四: 刷新access_token\r\n*`https:\u002F\u002Fapi.weixin.qq.com\u002Fsns\u002Foauth2\u002Frefresh_token?appid=APPID&grant_type=refresh_token&refresh_token=REFRESH_TOKEN`*\r\n\r\n\u003E 接口返回数据, 详见*https:\u002F\u002Fmp.weixin.qq.com\u002Fwiki?t=resource\u002Fres_main&id=mp1421140842*\r\n1. 第一步：用户同意授权，获取code\r\n\u003E 示例:( 注意appid, redirect_url是变量)\r\n```php\r\n$str = 'http:\u002F\u002Fopen.weixin.qq.com\u002Fconnect\u002Foauth2\u002Fauthorize?appid=wx20874ebf2ea1fc7f&redirect_uri=' . urlencode(\"http:\u002F\u002F192.168.253.1\u002Faudit\u002Fclient\u002F\") . '&response_type=code&scope=snsapi_base&state=123#wechat_redirect';\r\n```\r\n![enter description here][6]\r\n\r\n2. 第二步：通过code换取网页授权access_token\r\n\u003E 示例\r\n```php\r\n$data = json_decode(file_get_contents(\"https:\u002F\u002Fapi.weixin.qq.com\u002Fsns\u002Foauth2\u002Faccess_token?appid=\" . $this-\u003Eappid . \"&secret=\" . $this-\u003Esecret . \"&code=\" . $_GET['code'] . \"&grant_type=authorization_code\"));\r\n```\r\n\u003E **注意**: 此处的access_token与上面的access_token不是同一个东西\r\n3. 第三步: 通过access_token换取userinfo\r\n\u003E 示例\r\n```php\r\n$userInfo = json_decode(file_get_contents(\"https:\u002F\u002Fapi.weixin.qq.com\u002Fsns\u002Fuserinfo?access_token=\" . $data-\u003Eaccess_token . \"&openid=\" . $data-\u003Eopenid . \"&lang=zh_CN\"));\r\n```\r\n4. 刷新access_token, 如果需要\r\n\r\n\r\n\u003E 这是我画的一个请求过程图, 可以帮助理解\r\n\r\n![enter description here][7]\r\n\r\n\r\n### 测试演示\r\n\r\n#### 1. 将授权url发给手机\r\n\u003E 非必需, 也可以在电脑上, 也可以写到公众号子菜单中点击进入. \r\n\r\n#### 2. 关注测试号\r\n\u003E 不然会这样\r\n\r\n![enter description here][8]\r\n\r\n#### 关注后点击\r\n![enter description here][9]\r\n\r\n![enter description here][10]\r\n\r\n#### 测试号访问成功.\r\n\u003E 额, 关于后台代码原理就不讲了. \r\n\u003E 类似于一个从微信服务器发来的表单, 登录进了系统, 然后再把这些数据存入数据库就好了.\r\n\r\n### 正式号运行效果\r\n\r\n![enter description here][11]\r\n\r\n\r\n![enter description here][12]\r\n\r\n\r\n  [1]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523606408034.jpg\r\n  [2]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523712185351.jpg\r\n  [3]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523713636476.jpg\r\n  [4]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523781481068.jpg\r\n  [5]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523714004736.jpg\r\n  [6]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523714822433.jpg\r\n  [7]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20%281%29.svg \"未命名文件 &#40;1&#41;\"\r\n  [8]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523781959421.jpg\r\n  [9]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523782005232.jpg\r\n  [10]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523782015976.jpg\r\n  [11]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523890856126.jpg\r\n  [12]: https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E5%B0%8F%E4%B9%A6%E5%8C%A0\u002F2018-4-1523890881266.jpg",order:a,authorId:1,type:"post",status:"publish",commentsNum:a,allowComment:b,allowPing:b,allowFeed:b,parent:a,views:528,likes:a}}],fetch:{},mutations:void 0}}(0,"1")));