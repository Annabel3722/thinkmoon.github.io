__NUXT_JSONP__("/post/24", (function(a,b){return {data:[{article:{cid:24,title:"node环境安装canvas写中文并自定义字体生成图片",slug:"24",created:1542341580,modified:1547608170,text:"\u003C!--markdown--\u003E\u003E **为什么要在服务端装canvas？** 因为并不是所有的客户端都能很好的支持canvas（比如微信小程序不能修改自定义字体），所以我们需要一个\r\n能够在服务端生成图片的，然后将图片传输\r\n\r\n\r\n## 安装node-canvas\r\n### 1. 更新编译环境\r\n\r\n```bash\r\nsudo apt-get install libcairo2-dev libjpeg8-dev libpango1.0-dev libgif-dev build-essential g++ -y\r\n```\r\n### 2. 安装node-canvas\r\n```bash\r\nnpm install -g canvas\r\n```\r\n### 3. 测试代码\r\n```JavaScript\r\nvar Canvas = require('canvas'),\r\n    canvas = new Canvas(300, 200),\r\n    ctx = canvas.getContext('2d'),\r\n    fs = require('fs');\r\n \r\nvar out = fs.createWriteStream(__dirname + '\u002Fimage.png')\r\n  , stream = canvas.createPNGStream();\r\n \r\nstream.on('data', function(chunk){\r\n  out.write(chunk);\r\n});\r\n \r\n\u002F\u002F在左边画正方形\r\nctx.fillStyle = '#A00'    \r\nctx.fillRect(0, 30,50,50);   \r\n  \r\n \r\n\u002F\u002F在右边画正方形\r\nctx.fillStyle = '#aaa'    \r\nctx.fillRect(50, 30, 50, 50);\r\n \r\n\u002F\u002F画文字\r\nctx.fillStyle = \"#000\";\r\nctx.font = \"20px Arial\";\r\nctx.fillText(\"Hello World\", 0, 20);\r\n \r\n\u002F\u002F画一个圆\r\nctx.beginPath();\r\nctx.arc(30, 110, 20, 0, 2*Math.PI);\r\nctx.stroke();\r\nctx.fillStyle = \"green\";                                                                                                                          \r\nctx.fill();\r\nctx.save();  \r\n```\r\n## 可能遇到的问题\r\n\u003E 如果你按上述方法操作，并且运行成功了。那便是极好的\r\n\r\n### 1. 自定义字体\r\n```JavaScript\r\n\u002F\u002F You need to call it before the Canvas is created\r\nCanvas.registerFont('comicsans.ttf', {family: 'Comic Sans'});\r\n\r\nvar canvas = new Canvas(500, 500),\r\n  ctx = canvas.getContext('2d');\r\n\r\nctx.font = '12px \"Comic Sans\"';\r\nctx.fillText(250, 10, 'Everyone hates this font :(');\r\n```\r\n\u003E 不过可能会发现`Canvas.registerFont is not a function`这是因为npm版本的没有这个函数。\r\n\r\n所以你需要去找另一个github版`https:\u002F\u002Fgithub.com\u002Fchearon\u002Fnode-canvas#12971f64a66b`\r\n\r\ngit clone 下来\r\n\r\n\u003E 然后将Canvas = require('canvas')改成require('.\u002Fnode-canvas')，\r\n将`var canvas = new Canvas(300, 200)`改成`var canvas = new Canvas.Canvas(300, 200)`\r\n\r\n### 2. Error: Cannot find module '..\u002Fbuild\u002FRelease\u002Fcanvas.node'\r\n\u003E 如果遇到这个问题，请cd进你的node-canvas目录执行npm install\r\n\r\n\u003E 如果还是不行，请执行`npm install -g node-gyp`\r\n\r\n然后再cd项目目录执行`node-gyp rebuild`，then cd 进node-canvas同样执行`node-gyp rebuild`\r\n\r\n如果成功则会出现\r\n\r\n![编译过程](https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20180619203241.png)\r\n\r\n## 示例代码\r\n### 我的项目目录\r\n```\r\n.\r\n├── 1.html\r\n├── composer.json\r\n├── font\r\n├── fz.ttf\r\n├── img\r\n├── index.js\r\n├── node-canvas\r\n├── node_modules\r\n├── package.json\r\n└── package-lock.json\r\n```\r\n### 我的代码\r\n```JavaScript\r\nvar fs = require('fs'),path = require('path');\r\nvar http = require('http'),url = require(\"url\");\r\nvar Canvas = require('.\u002Fnode-canvas'),Image = Canvas.Image;\r\nvar Fonts = [];\r\nvar filePath = path.resolve('.\u002Ffont');\r\n\r\nlet promise = new Promise(function(resolve, reject) {\r\n  let i=0;\r\n  fs.readdir(filePath,function(err,files){  \r\n    if(err){  \r\n      console.warn(err)  \r\n    }else{\r\n      files.forEach(function(filename){\r\n        Canvas.registerFont(filePath + \"\u002F\" + filename, {family: \"font\" + i});\r\n        console.log(i);\r\n        i++;\r\n      });\r\n    }\r\n  });\r\n  \r\n});\r\n\r\npromise.then(function() {\r\n  console.log(\"ASDF\");\r\n  Fonts.forEach((Element) =\u003E{\r\n    console.log(Element);\r\n  });\r\n});\r\n\r\nconsole.log('Hi!');\r\n\r\n\r\nhttp.createServer(function (req, res) {\r\n  var params = url.parse(req.url, true).query;\r\n  var str = params.str + '\\r',site = params.site;\r\n  var row =  1,col = 15,width = 1500;\r\n  row = str.length \u002F 15 + 1;\r\n  var fontsize = width\u002Fcol;\r\n  var height = fontsize * row + 200;\r\n  if(height \u003C 1000){height = 1000}\r\n  var canvas = new Canvas.Canvas(width, height), ctx = canvas.getContext('2d')\r\n  res.writeHead(200,{\"Content-Type\": \"image\u002Fpng\"});\r\n  ctx.fillStyle = '#FFF';\r\n  ctx.fillRect(0,0,canvas.width, canvas.height);\r\n  ctx.fillStyle = '#000';\r\n  if(row \u003C 2){\r\n    let num = str.length\r\n    fontsize = 1200 \u002F num;\r\n    ctx.font = fontsize + 'px \"font'+ site +'\"';\r\n    ctx.fillText(str,( width - num * fontsize ) \u002F 2, (height-fontsize)\u002F2 -200 + fontsize);\r\n  }\r\n  else{\r\n    ctx.font = fontsize + 'px \"font'+ site +'\"';\r\n    for(let i = 0;i \u003C row ; i++){\r\n      ctx.fillText(str.substring(i*15,(i+1)*15), 0, fontsize*(i+1));\r\n    }\r\n  }\r\n  \r\n  fs.readFile(__dirname + '\u002Fimg\u002Fbrand.png', function(err, squid){\r\n    if (err) throw err;\r\n    img = new Image;\r\n    img.src = squid;\r\n    ctx.fillStyle = '#42b983';\r\n    ctx.fillRect(0,canvas.height - 230,canvas.width, 230);\r\n    ctx.drawImage(img, canvas.width - img.width \u002F 2 - 50, canvas.height - img.height \u002F 2 - 50, img.width \u002F 2, img.height \u002F 2);\r\n    res.end(canvas.toBuffer());\r\n  });\r\n}).listen(8080);\r\n```\r\n## 效果展示\r\n![天地玄黄](https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002FTIM%E5%9B%BE%E7%89%8720180620125239.png)",order:a,authorId:1,type:"post",status:"publish",commentsNum:a,allowComment:b,allowPing:b,allowFeed:b,parent:a,views:1272,likes:2}}],fetch:{},mutations:void 0}}(0,"1")));